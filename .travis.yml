sudo: required
language: ruby

cache:
  bundler: true
  directories:
    - node_modules
    - travis_phantomjs
  yarn: true
bundler_args: --without development

rvm:
  - 2.4.1
env:
  - DB=sqlite

services:
  - elasticsearch

before_install:
  - export TZ=Europe/Paris
  - nvm install 7.7.0
  - npm i -g yarn@0.24.4
  - bin/yarn install

  # Install PhantomJS version 2.1.1
  - "export PATH=$PWD/travis_phantomjs/phantomjs-2.1.1-linux-x86_64/bin:$PATH"
  - "hash -d phantomjs || true"
  - "if [ $(phantomjs --version) != '2.1.1' ]; then rm -rf $PWD/travis_phantomjs; mkdir -p $PWD/travis_phantomjs; fi"
  - "if [ $(phantomjs --version) != '2.1.1' ]; then wget https://assets.membergetmember.co/software/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O $PWD/travis_phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2; fi"
  - "if [ $(phantomjs --version) != '2.1.1' ]; then tar -xvf $PWD/travis_phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2 -C $PWD/travis_phantomjs; fi"

before_script:
  - sleep 8 # wait for elasticsearch
  - cp .env{.sample,}
  - RAILS_ENV=test bin/rails webpacker:compile
  - RAILS_ENV=test bin/rails db:migrate

script:
  - bin/rspec
  - bin/rubocop
  - eslint -f table 'app/javascripts/**'

after_script:
  - RAILS_ENV=test bin/rails db:seed

after_success:
  - bundle exec codeclimate-test-reporter

after_failure:
  - date
  - cat ./config/database.yml
  - echo $RAILS_ENV
  - bin/rake --version
  - node --version
  - phantomjs -v

matrix:
  fast_finish: true

branches:
  only:
    - master
    - develop

addons:
  code_climate:
    repo_token:
      secure: "dYsryV/LSmZXU7k1RXiPnRG2tNpiaEUvXpBYm1szq9oCZNZQkrucbELEomSxZ0/Z1AezK5JC5TGBzEKefycYwiUXS0mgrWQwlXvVgawMeBbUgG6TQpK3MQboYe+JLramy0tNc999ViaCCnlMk2Vht0+tLMLuWstqKEx2WM4ZK4rWkumv98APC+4j9gJK4PRiYcfV42jQLYulZ0mhOPrsWxWPh1qHQrlVicenFLrE5U5V9eXrz124HBVt8fhhUYp5KylTNZRDx9xe4Ak69Xqd6E8iWfXVWbKa3lsbKEdhycO2vs1SUr/q4VS9cnPqNHcooefAGOviGJjbntkyTxgJqybRQByg2W1Dur9dpyJpgErLztjoyvAG2zZ6w2AEuLyEwhw1B4pimd13D/yZgEZyBriqih1ViLe6KQ8Z5R0O3mdm4S6HheN/Eby4rhj0YrR5uHZ+2abOEXGbV6C+guz6z9yjo8gbm2U8O+llihTMm3/RNOwzmuln+uYcqZlgX4vMkSU+zhSBc9mmE4zzaFfhta4XydiGOG8BK9SrQujyScDByZW11mTb/wDlLAZv0UaBcNYClC2TRkAMRS0ECs9PF9wx+9ACZei/RoDfEQFBncDITmAhj1YvZG7FP6req6Tu78IkJjsL+mrdK3HlwpJ3r0Qv3tBIgKUQga97ee9MmKw="

notifications:
  email: false
